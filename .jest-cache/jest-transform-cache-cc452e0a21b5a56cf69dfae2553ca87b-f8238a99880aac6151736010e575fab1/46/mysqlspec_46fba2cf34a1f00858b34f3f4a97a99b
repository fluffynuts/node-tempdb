1009434a8ec795926b682decccf15a11
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
require("expect-even-more-jest");
const tempdb_1 = require("../src/tempdb");
const knex_1 = __importDefault(require("knex"));
const expect_even_more_jest_1 = require("expect-even-more-jest");
describe(`node-tempdb: mysql support`, () => {
    it(`should provide a temp mysql database when available`, async () => {
        // Arrange
        const instance = create();
        // Act
        const connectionInfo = await instance.start();
        // Assert
        const conn = knexConnect(connectionInfo.knexConfig);
        const result = await conn.select("TABLE_NAME")
            .from("INFORMATION_SCHEMA.TABLES");
        expect(result)
            .not.toBeEmptyArray();
    });
    it(`should time out when no activity and configured to time out`, async () => {
        // Arrange
        const instance = create({
            type: tempdb_1.Databases.mysql,
            inactivityTimeoutSeconds: 2
        });
        // Act
        const connectionInfo = await instance.start();
        const conn = knexConnect(connectionInfo.knexConfig);
        await expect(conn.select("TABLE_NAME")
            .from("INFORMATION_SCHEMA.TABLES")).resolves.not.toThrow();
        await expect_even_more_jest_1.sleep(3000);
        await expect(conn.select("TABLE_NAME")
            .from("INFORMATION_SCHEMA.TABLES")).rejects.toThrow();
        // Assert
    });
    it(`should time out on absolute timeout when configured to time out`, async () => {
        // Arrange
        const instance = create({
            type: tempdb_1.Databases.mysql,
            inactivityTimeoutSeconds: 20,
            absoluteLifespanSeconds: 2
        });
        // Act
        const connectionInfo = await instance.start();
        const conn = knexConnect(connectionInfo.knexConfig);
        await expect(conn.select("TABLE_NAME")
            .from("INFORMATION_SCHEMA.TABLES")).resolves.not.toThrow();
        await expect_even_more_jest_1.sleep(3000);
        await expect(conn.select("TABLE_NAME")
            .from("INFORMATION_SCHEMA.TABLES")).rejects.toThrow();
        // Assert
    });
    beforeEach(() => {
        jest.setTimeout(60000);
    });
    const instances = [];
    function create(options) {
        const result = new tempdb_1.TempDb(options);
        instances.push(result);
        return result;
    }
    let connections = [];
    function knexConnect(config) {
        const result = knex_1.default(config);
        connections.push(result);
        return result;
    }
    afterEach(async () => {
        const toStop = instances.splice(0, instances.length);
        for (let instance of toStop) {
            try {
                await instance.stop();
            }
            catch (e) {
                if (e.exitCode === 1) {
                    continue;
                }
                console.error(`TempDb Runner process exits with unexpected code: ${e.exitCode}`, e);
            }
        }
        const conns = connections.splice(0, connections.length);
        for (let conn of conns) {
            await conn.destroy();
        }
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQzpcXGNvZGVcXG9wZW5zb3VyY2VcXG5vZGUtdGVtcGRiXFx0ZXN0c1xcbXlzcWwuc3BlYy50cyIsInNvdXJjZXMiOlsiQzpcXGNvZGVcXG9wZW5zb3VyY2VcXG5vZGUtdGVtcGRiXFx0ZXN0c1xcbXlzcWwuc3BlYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQUFBLGlDQUErQjtBQUMvQiwwQ0FBaUU7QUFDakUsZ0RBQXdCO0FBRXhCLGlFQUE4QztBQUU5QyxRQUFRLENBQUMsNEJBQTRCLEVBQUUsR0FBRyxFQUFFO0lBQ3hDLEVBQUUsQ0FBQyxxREFBcUQsRUFBRSxLQUFLLElBQUksRUFBRTtRQUNqRSxVQUFVO1FBQ1YsTUFBTSxRQUFRLEdBQUcsTUFBTSxFQUFFLENBQUM7UUFDMUIsTUFBTTtRQUNOLE1BQU0sY0FBYyxHQUFHLE1BQU0sUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQzlDLFNBQVM7UUFDVCxNQUFNLElBQUksR0FBRyxXQUFXLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQyxDQUFDO1FBQ3BELE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUM7YUFDekMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLENBQUM7UUFDdkMsTUFBTSxDQUFDLE1BQU0sQ0FBQzthQUNULEdBQUcsQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUM5QixDQUFDLENBQUMsQ0FBQztJQUVILEVBQUUsQ0FBQyw2REFBNkQsRUFBRSxLQUFLLElBQUksRUFBRTtRQUN6RSxVQUFVO1FBQ1YsTUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDO1lBQ3BCLElBQUksRUFBRSxrQkFBUyxDQUFDLEtBQUs7WUFDckIsd0JBQXdCLEVBQUUsQ0FBQztTQUM5QixDQUFDLENBQUE7UUFDRixNQUFNO1FBQ04sTUFBTSxjQUFjLEdBQUcsTUFBTSxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDOUMsTUFBTSxJQUFJLEdBQUcsV0FBVyxDQUFDLGNBQWMsQ0FB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QztRQUN4RCxLQUFLLElBQUksSUFBSSxJQUFJLEtBQUssRUFBRTtZQUNwQixNQUFNLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUN4QjtJQUNMLENBQUMsQ0FBQyxDQUFDO0FBQ1AsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXCJleHBlY3QtZXZlbi1tb3JlLWplc3RcIjtcclxuaW1wb3J0IHsgRGF0YWJhc2VzLCBUZW1wRGIsIFRlbXBEYk9wdGlvbnMgfSBmcm9tIFwiLi4vc3JjL3RlbXBkYlwiO1xyXG5pbXBvcnQgS25leCBmcm9tIFwia25leFwiO1xyXG5pbXBvcnQgeyBLbmV4Q29uZmlnIH0gZnJvbSBcIi4uL3NyYy9jb25uZWN0aW9uLWluZm9cIjtcclxuaW1wb3J0IHsgc2xlZXAgfSBmcm9tIFwiZXhwZWN0LWV2ZW4tbW9yZS1qZXN0XCI7XHJcblxyXG5kZXNjcmliZShgbm9kZS10ZW1wZGI6IG15c3FsIHN1cHBvcnRgLCAoKSA9PiB7XHJcbiAgICBpdChgc2hvdWxkIHByb3ZpZGUgYSB0ZW1wIG15c3FsIGRhdGFiYXNlIHdoZW4gYXZhaWxhYmxlYCwgYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIC8vIEFycmFuZ2VcclxuICAgICAgICBjb25zdCBpbnN0YW5jZSA9IGNyZWF0ZSgpO1xyXG4gICAgICAgIC8vIEFjdFxyXG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb25JbmZvID0gYXdhaXQgaW5zdGFuY2Uuc3RhcnQoKTtcclxuICAgICAgICAvLyBBc3NlcnRcclxuICAgICAgICBjb25zdCBjb25uID0ga25leENvbm5lY3QoY29ubmVjdGlvbkluZm8ua25leENvbmZpZyk7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY29ubi5zZWxlY3QoXCJUQUJMRV9OQU1FXCIpXHJcbiAgICAgICAgICAgIC5mcm9tKFwiSU5GT1JNQVRJT05fU0NIRU1BLlRBQkxFU1wiKTtcclxuICAgICAgICBleHBlY3QocmVzdWx0KVxyXG4gICAgICAgICAgICAubm90LnRvQmVFbXB0eUFycmF5KCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBpdChgc2hvdWxkIHRpbWUgb3V0IHdoZW4gbm8gYWN0aXZpdHkgYW5kIGNvbmZpZ3VyZWQgdG8gdGltZSBvdXRgLCBhc3luYyAoKSA9PiB7XHJcbiAgICAgICAgLy8gQXJyYW5nZVxyXG4gICAgICAgIGNvbnN0IGluc3RhbmNlID0gY3JlYXRlKHtcclxuICAgICAgICAgICAgdHlwZTogRGF0YWJhc2VzLm15c3FsLFxyXG4gICAgICAgICAgICBpbmFjdGl2aXR5VGltZW91dFNlY29uZHM6IDJcclxuICAgICAgICB9KVxyXG4gICAgICAgIC8vIEFjdFxyXG4gICAgICAgIGNvbnN0IGNvbm5lY3Rpb25JbmZvID0gYXdhaXQgaW5zdGFuY2Uuc3RhcnQoKTtcclxuICAgICAgICBjb25zdCBjb25uID0ga25leENvbm5lY3QoY29ubmVjdGlvbkluZm8ua25leENvbmZpZyk7XHJcbiAgICAgICAgYXdhaXQgZXhwZWN0KGNvbm4uc2VsZWN0KFwiVEFCTEVfTkFNRVwiKVxyXG4gICAgICAgICAgICAuZnJvbShcIklORk9STUFUSU9OX1NDSEVNQS5UQUJMRVNcIilcclxuICAgICAgICApLnJlc29sdmVzLm5vdC50b1Rocm93KCk7XHJcbiAgICAgICAgYXdhaXQgc2xlZXAoMzAwMCk7XHJcbiAgICAgICAgYXdhaXQgZXhwZWN0KGNvbm4uc2VsZWN0KFwiVEFCTEVfTkFNRVwiKVxyXG4gICAgICAgICAgICAuZnJvbShcIklORk9STUFUSU9OX1NDSEVNQS5UQUJMRVNcIilcclxuICAgICAgICApLnJlamVjdHMudG9UaHJvdygpO1xyXG4gICAgICAgIC8vIEFzc2VydFxyXG4gICAgfSk7XHJcblxyXG4gICAgaXQoYHNob3VsZCB0aW1lIG91dCBvbiBhYnNvbHV0ZSB0aW1lb3V0IHdoZW4gY29uZmlndXJlZCB0byB0aW1lIG91dGAsIGFzeW5jICgpID0+IHtcclxuICAgICAgICAvLyBBcnJhbmdlXHJcbiAgICAgICAgY29uc3QgaW5zdGFuY2UgPSBjcmVhdGUoe1xyXG4gICAgICAgICAgICB0eXBlOiBEYXRhYmFzZXMubXlzcWwsXHJcbiAgICAgICAgICAgIGluYWN0aXZpdHlUaW1lb3V0U2Vjb25kczogMjAsXHJcbiAgICAgICAgICAgIGFic29sdXRlTGlmZXNwYW5TZWNvbmRzOiAyXHJcbiAgICAgICAgfSlcclxuICAgICAgICAvLyBBY3RcclxuICAgICAgICBjb25zdCBjb25uZWN0aW9uSW5mbyA9IGF3YWl0IGluc3RhbmNlLnN0YXJ0KCk7XHJcbiAgICAgICAgY29uc3QgY29ubiA9IGtuZXhDb25uZWN0KGNvbm5lY3Rpb25JbmZvLmtuZXhDb25maWcpO1xyXG4gICAgICAgIGF3YWl0IGV4cGVjdChjb25uLnNlbGVjdChcIlRBQkxFX05BTUVcIilcclxuICAgICAgICAgICAgLmZyb20oXCJJTkZPUk1BVElPTl9TQ0hFTUEuVEFCTEVTXCIpXHJcbiAgICAgICAgKS5yZXNvbHZlcy5ub3QudG9UaHJvdygpO1xyXG4gICAgICAgIGF3YWl0IHNsZWVwKDMwMDApO1xyXG4gICAgICAgIGF3YWl0IGV4cGVjdChjb25uLnNlbGVjdChcIlRBQkxFX05BTUVcIilcclxuICAgICAgICAgICAgLmZyb20oXCJJTkZPUk1BVElPTl9TQ0hFTUEuVEFCTEVTXCIpXHJcbiAgICAgICAgKS5yZWplY3RzLnRvVGhyb3coKTtcclxuICAgICAgICAvLyBBc3NlcnRcclxuICAgIH0pO1xyXG5cclxuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xyXG4gICAgICAgIGplc3Quc2V0VGltZW91dCg2MDAwMCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCBpbnN0YW5jZXM6IFRlbXBEYltdID0gW107XHJcblxyXG4gICAgZnVuY3Rpb24gY3JlYXRlKFxyXG4gICAgICAgIG9wdGlvbnM/OiBUZW1wRGJPcHRpb25zXHJcbiAgICApIHtcclxuICAgICAgICBjb25zdCByZXN1bHQgPSBuZXcgVGVtcERiKG9wdGlvbnMpO1xyXG4gICAgICAgIGluc3RhbmNlcy5wdXNoKHJlc3VsdCk7XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgY29ubmVjdGlvbnM6IGFueVtdID0gW107XHJcblxyXG4gICAgZnVuY3Rpb24ga25leENvbm5lY3QoY29uZmlnOiBLbmV4Q29uZmlnKSB7XHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gS25leChjb25maWcpO1xyXG4gICAgICAgIGNvbm5lY3Rpb25zLnB1c2gocmVzdWx0KTtcclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuXHJcbiAgICBhZnRlckVhY2goYXN5bmMgKCkgPT4ge1xyXG4gICAgICAgIGNvbnN0IHRvU3RvcCA9IGluc3RhbmNlcy5zcGxpY2UoMCwgaW5zdGFuY2VzLmxlbmd0aCk7XHJcbiAgICAgICAgZm9yIChsZXQgaW5zdGFuY2Ugb2YgdG9TdG9wKSB7XHJcbiAgICAgICAgICAgIHRyeSB7XHJcbiAgICAgICAgICAgICAgICBhd2FpdCBpbnN0YW5jZS5zdG9wKCk7XHJcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICAgICAgICAgIGlmIChlLmV4aXRDb2RlID09PSAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKGBUZW1wRGIgUnVubmVyIHByb2Nlc3MgZXhpdHMgd2l0aCB1bmV4cGVjdGVkIGNvZGU6ICR7ZS5leGl0Q29kZX1gLCBlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBjb25zdCBjb25ucyA9IGNvbm5lY3Rpb25zLnNwbGljZSgwLCBjb25uZWN0aW9ucy5sZW5ndGgpO1xyXG4gICAgICAgIGZvciAobGV0IGNvbm4gb2YgY29ubnMpIHtcclxuICAgICAgICAgICAgYXdhaXQgY29ubi5kZXN0cm95KCk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcbn0pO1xyXG4iXX0=